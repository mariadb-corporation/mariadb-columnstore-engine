#!/bin/bash
#
# $Id: post-uninstall 421 2007-04-05 15:46:55Z dhill $
#
# Post-uninstall steps for columnstore install

prefix=/usr/local
installdir=$prefix/mariadb/columnstore
rpmmode=install
user=`whoami 2>/dev/null`

quiet=0

for arg in "$@"; do
	if [ `expr -- "$arg" : '--prefix='` -eq 9 ]; then
		prefix="`echo $arg | awk -F= '{print $2}'`"
		installdir=$prefix/mariadb/columnstore
	elif [ `expr -- "$arg" : '--rpmmode='` -eq 10 ]; then
		rpmmode="`echo $arg | awk -F= '{print $2}'`"
	elif [ `expr -- "$arg" : '--installdir='` -eq 13 ]; then
		installdir="`echo $arg | awk -F= '{print $2}'`"
		prefix=`dirname $installdir`
		prefix=`dirname $prefix`
	elif [ `expr -- "$arg" : '--user='` -eq 7 ]; then
		user="`echo $arg | awk -F= '{print $2}'`"
	elif [ `expr -- "$arg" : '--quiet'` -eq 7 ]; then
		quiet=1
	else
		echo "post-uninstall: ignoring unknown argument: $arg" 1>&2
	fi
done

#stop services
$installdir/bin/columnstore stop > /dev/null 2>&1
$installdir/myql/columnstore-Mysql stop > /dev/null 2>&1

export COLUMNSTORE_INSTALL_DIR=$installdir

cloud=`$COLUMNSTORE_INSTALL_DIR/bin/getConfig Installation Cloud`
if [ $cloud = "amazon-ec2" ] || [ $cloud = "amazon-vpc" ]; then
	if test -f /etc/fstab ; then
	    sed -i '/Columnstore\/data/d' /etc/fstab > /dev/null 2>&1
	fi
fi

#remove profile file
if [ $user != "root" ]; then
	profileFile=$prefix/.bash_profile

	if test -f ${profileFile}_backup ; then
	    mv -f ${profileFile}_backup $profileFile
	fi
else
	rm -f /etc/profile.d/columnstoreAlias.sh
fi

 
#remove log file directories
#rm -rf /var/log/mariadb/columnstore > /dev/null 2>&1
#rm -f $installdir/mysql/db/*.err > /dev/null 2>&1
rm -f /var/log/mariadb/columnstore/activeAlarms > /dev/null 2>&1
rm -f /var/log/mariadb/columnstore/*.log1 > /dev/null 2>&1
rm -rf $installdir/mysql/db/columnstore_log_archive > /dev/null 2>&1

# delete Mariab Columnstore shared memory segments
$installdir/bin/clearShm  > /dev/null 2>&1

# delete tmp files
rm -f $installdir/local/*.columnstore
rm -rf $installdir/local/etc/
rm -rf /tmp/bucketreuse
rm -f /tmp/columnstore.txt
rm -f /tmp/dbbuilder.*
rm -f /tmp/dbrmfiles
rm -f /tmp/pkgcheck
rm -f /tmp/upgrade-status.log.*
rm -f /tmp/mount.log
rm -f $installdir/data/bulk/tmpjob/* >/dev/null 2>&1
rm -rf /tmp/columnstore_tmp_files
rm -f $installdir/local/moveDbrootTransactionLog

lockdir=`$COLUMNSTORE_INSTALL_DIR/bin/getConfig Installation LockFileDirectory`
rm -f $lockdir/columnstore
rm -f $lockdir/mysql-Columnstore

# delete core files
#rm -f /var/log/mariadb/columnstore/corefiles/* > /dev/null 2>&1

#uninstall MariaDB Columnstore system logging
if [ -x $installdir/bin/syslogSetup.sh ]; then
	if [ $user = "root" ]; then
		$installdir/bin/syslogSetup.sh uninstall >/dev/null 2>&1
	fi
fi

#remove the start service command
if [ $user = "root" ]; then
	systemctl=`which systemctl 2>/dev/null`
	if [ -n "$systemctl" ]; then

		systemctl disable columnstore >/dev/null 2>&1
		rm -f /usr/lib/systemd/system/columnstore.service
		rm -f /lib/systemd/system/columnstore.service
	else
		chkconfig=`which chkconfig 2>/dev/null`
		if [ -n "$chkconfig" ]; then

			chkconfig columnstore off > /dev/null 2>&1
			chkconfig --del columnstore > /dev/null 2>&1
			rm -f /etc/init.d/columnstore > /dev/null 2>&1
		else
			updaterc=`which update-rc.d 2>/dev/null`
			if [ -n "$updaterc" ]; then

				update-rc.d -f columnstore remove > /dev/null 2>&1
				rm -f /etc/init.d/columnstore > /dev/null 2>&1	
			fi
		fi
	fi
fi

if [ $quiet != 1 ]; then
	#make copy of Columnstore.xml
	/bin/cp -f $installdir/etc/Columnstore.xml $installdir/etc/Columnstore.xml.rpmsave > /dev/null 2>&1
	/bin/cp -f $installdir/mysql/my.cnf $installdir/mysql/my.cnf.rpmsave > /dev/null 2>&1
	rm -f $installdir/etc/AlarmConfig.xml.installSave
fi

#remove OAMdbrootCheck file
rm -f $installdir/data*/OAMdbrootCheck > /dev/null 2>&1

#remove library paths
if [ $user = "root" ]; then
        rm -f /etc/ld.so.conf.d/columnstore.conf
        ldconfig
else
	rm -f /etc/default/columnstore
	 
	echo ""
	echo "NOTE: For non-root install, you will need to run the following command as root user to"
	echo "      uninstall the MariaDB ColumnStore System Logging"
	echo ""
	echo "      $installdir/bin/syslogSetup.sh --installdir=$installdir --user=$user uninstall"
	echo ""

fi

#tell user to run post configure script
echo " "
echo "Mariab Columnstore uninstall completed"

exit 0

