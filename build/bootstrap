#!/bin/bash
#
# $Id: bootstrap 1333 2011-01-18 17:25:26Z rdempsey $
#
# This script is responsible for setting up a fresh development tree
# following a git checkout.  It copies static files and shared include
# files to the export tree prior to building the software.

set -e

mkdir -p export/{include,lib,etc,share,bin,sbin,post,mysql}
params="$(getopt -o p:i: -l prefix:,include: --name "$cmdname" -- "$@")"

eval set -- "$params"
unset params

while true
	do
	case $1 in
		--include)
		INCLUDE+="-I${2-} "
		shift 2
		;;
		--prefix)
		PREFIX="${2-}"
		shift 2
		;;

		--)
		shift
		break
		;;
	esac
done

export CXXFLAGS=$INCLUDE $CXXFLAGS

#TODO: these prebuilt binaries may need to be fetched
#and built as dependencies

#cp build/gdb export/bin
#cp build/libgcc_s.so.1 export/lib 
#cp build/libstdc++.so.6.0.14 export/lib

#FIXME rename this
cp dbcon/mysql/install_calpont_mysql.sh export/mysql/

#TODO: see if this my.cnf is necessary
cp dbcon/mysql/my.cnf export/mysql/.

#TODO: the init.d service file should not be mixed case
#TODO: the init.d service file should not contain calpont
cp dbcon/mysql/mysql-Columnstore export/mysql/ && \
cp build/files.lst export/mysql/ && \
cp dbcon/mysql/install_calpont_mysql.sh export/mysql/ && \
cp dbcon/mysql/my.cnf export/mysql/ && \
cp dbcon/mysql/mysql-Columnstore export/mysql/

cp -p -r utils/net-snmp export/include

d=utils/net-snmp-built-libs/lib64
for lib in libnetsnmpagent.so libnetsnmphelpers.so libnetsnmpmibs.so libnetsnmp.so libnetsnmptrapd.so; do
	ln -svf $lib.5.2.1 $d/$lib
done
#FIXME: 
# This has to be terribly broken, especially for 32 bit
# platforms.  There should be no PRE-BUILT tools in someting
# that is being built.  If we need a custom compilation of
# net-snmp for some reason then we will have to BUILD IT
# as part of the bootstrap process.
# I am commenting this out to see exactly what breaks in the build
# process.
 if [ `uname -m` == "x86_64" ]; then
 	cp -p utils/net-snmp-built-libs/lib64/* export/lib
 	cp -p utils/net-snmp-built-libs/bin64/* export/sbin
 else
 	egrep -qs Constantine /etc/redhat-release
 	if [ $? -eq 0 ]; then
 		cp -p utils/net-snmp-built-libs/fc12lib/libnetsnmp*.so.* export/lib
 		cp -p utils/net-snmp-built-libs/fc12bin/* export/sbin
 	else
 		cp -p utils/net-snmp-built-libs/fc6lib/libnetsnmp*.so.* export/lib
 		cp -p utils/net-snmp-built-libs/fc6bin/* export/sbin
 	fi
 fi

#FIXME:
#This is not going to update the version in configure.ac
echo Generating version header
./build/genVersion.sh
if [ $? -ne 0 ]; then
  echo Could not generate version header
  exit $?
fi

echo Running GNU autotools to generate build environment
aclocal && \
autoconf && \
autoheader && \
libtoolize && \
automake --add-missing && \
autoreconf

if [ $? -ne 0 ]; then
  echo GNU autotools generation failed
  exit $?
fi


echo GNU autotools environment generation completed successfully

echo Configuring MariaDB ColumnStore

if [ -n "$PREFIX" ]; 
then
	echo "BUILDING WITH PREFIX=$PREFIX"
	./configure --prefix=$PREFIX
else
	echo "BUILDING WITH DEFAULT PREFIX"
	./configure
fi

#for x in \
#$(find . -name '[mM]akefile' \
#    | xargs grep -l ^bootstrap: \
#    | cut -f 2 -d / \
#    | sort -u)
#do
#  echo bootstrapping $x
#  make BOOTSTRAP=1 -C $x bootstrap
#done

