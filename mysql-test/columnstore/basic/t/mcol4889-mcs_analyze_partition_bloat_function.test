#
# Test mcs_analyze_table_bloat() function
# Author: Ziy1-Tan, tanziyi0925@gmail.com
#
-- source ../include/have_columnstore.inc

--disable_warnings
DROP DATABASE IF EXISTS mcol4889_db1;
--enable_warnings

CREATE DATABASE IF NOT EXISTS mcol4889_db1;
USE mcol4889_db1;

CREATE TABLE t1(col1 INT, col2 INT, col3 CHAR(8)) ENGINE=COLUMNSTORE;
--replace_result $MTR_SUITE_DIR MTR_SUITE_DIR
--eval LOAD DATA LOCAL infile '$MTR_SUITE_DIR/../std_data/100Krows.dat' INTO TABLE t1 FIELDS TERMINATED BY '|';

SELECT COUNT(*) FROM t1;
INSERT INTO t1 SELECT * FROM t1;
INSERT INTO t1 SELECT * FROM t1;
INSERT INTO t1 SELECT * FROM t1;
INSERT INTO t1 SELECT * FROM t1;
INSERT INTO t1 SELECT * FROM t1;
INSERT INTO t1 SELECT * FROM t1;
INSERT INTO t1 SELECT * FROM t1;
SELECT COUNT(*) FROM t1;

let $func_exists=`SELECT COUNT(*) FROM mysql.func WHERE name='mcs_analyze_partition_bloat'`;

--disable_query_log
if (!$func_exists)
{
  CREATE FUNCTION mcs_analyze_partition_bloat RETURNS STRING SONAME "ha_columnstore.so";
}
--enable_query_log

SELECT mcs_analyze_partition_bloat('t1', '0.0.1');

SELECT mcs_analyze_partition_bloat('t1', '1.0.1');

--disable_query_log
if (!$func_exists)
{
  DROP FUNCTION calshowpartitions;
}
--enable_query_log

# Clean UP
DROP DATABASE mcol4889_db1;
